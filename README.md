# Twilify
Generate a Spotify playlist based on your current musical interests or mood by texting a Twilio-owned phone number which triggers a Cloud API in your personal account.
Easy AWS or GCP-based serverless deployment automated via Terraform.

## Current Version: 2.0.0 - Multi-Cloud (AWS & GCP) Support
One-script installation/deployment into AWS or GCP (why not both? ;) and automated Twilio webhook configuration for easy use. Once texted, initial playlist is created with name "Twilify" within seconds. Experiment with personalized playlist customization through text-based keywords, grant your friends permission to text the app themselves, investigate a hit new track and see how it was generated, but most importantly - quit trying to decide what music to listen to!

# Installation

## Prerequisites
* AWS CLI or gcloud installed - https://aws.amazon.com/cli/ or https://cloud.google.com/sdk/docs/install
* Terraform installed - https://www.terraform.io/
* A Twilio phone number capable of sending/receiving SMS - https://console.twilio.com/
    * As of July 2023, a verified A2P campaign is required for CPaaS usage, several days to get approved for personal use-case
* A Spotify account
* A Spotify application created at https://developer.spotify.com/ allowing API access to your account

## Instructions
1. To start install, change directory to twilify/aws or twilify/gcp
2. Provide various account information needed in terraform.tfvars file (see variables.tf file for reference) - account/project ID, Spotify account, Twilio number, etc
3. Make sure terraform is installed and that it has access with necessary permission to create resources in your chosen Cloud provider
4. Run setup.sh script to build and deploy app, as well as update Twilio phone number webhook URL, no manual configuration required
5. Text your Twilify number to say hi, and enjoy your new playlist :)

# Usage

- In general, texting Twilify will replace all songs in the Twilify playlist with the default number of new songs (set as Terraform var)
- Songs will be generated by randomly combining 1-3 songs in a user's Spotify current top tracks as seeds for new song generation
- For more customizable playlist, several keywords can be included in the text body, see table below
- Case does NOT matter for your SMS messages, don't worry about auto-caps!

## Available SMS Keywords

|           Keyword           | Sample Usage in SMS Message |                                         Description if Required                                        |
|:---------------------------:|:---------------------------:|:------------------------------------------------------------------------------------------------------:|
| Energy [high\|medium\|low]  | energy medium               |                                                                                                        |
| Happy                       | Happy yay!                  | Brighter                                                                                               |
| Sad                         | sad :(                      | Darker                                                                                                 |
| Instrumental                | instrumental                | Less vocal                                                                                             |
| Tempo [number]              | tempo 140                   |                                                                                                        |
| Dance                       | DANCE party                 | More danceable songs                                                                                   |
| Size [number]               | size 21                     | Add this many songs to the playlist for one iteration                                                  |
| Keep                        | keep                        | Does not get rid of all songs automatically,  attempts to add new songs to reach desired size          |
| Seeds [number]              | seeds 9                     | Do NOT update playlist, but return name of song(s) that  helped generate the 9th track in the playlist |
| Overwrite                   | overwrite                   | (Initial text after install only) Use if Twilify was installed previously and there is an existing playlist with correct name to overwrite instead of creating new |


# Uninstall
1. Execute "terraform destroy" to get rid of everything in AWS or GCP, delete the playlist in Spotify, and don't forget to release the Twilio number. Poof, it's all gone.


# Backlog
- Use S3 bucket keys for KMS encryption to reduce cost 
- Need ability to accidentally delete spotify playlist and resume without having to recreate songbank, migrate keyword
- alert all registered numbers when fresh music is ready (can opt out via text?)
- "classic" song keyword, want to mostly enjoy new stuff or sing to what you already love? - long term favs
- Want endless keyword so playlist keeps refreshing with new tracks as I listen without needing to text every so often, until I stop the endlessness via text
- Add S3 bucket versioning to be able to lookup previous songbanks if desired, lifecycle policy to minimize storage costs


# Completed Work

- Support for deploying into Google Cloud and AWS
- Spotify refresh token saved as SSM Parameter Store as encrypted string, not in S3 with songbank
- Fixed bug: Twilify doesn't immediately respond with warmup message - switched to serverless instead of VPC
- Songbank keeps track of / increments play count for songs even when removed from playlist
- Fixed bug: Twilify can fail when writing new songbank back to S3, put object call is timing out - added network connectivity check at start and max retries/timeouts added for boto3, verified retries via CloudWatch logs
- Fixed bug: Spotify calls timing out retrieving refresh token - switched to serverless instead of VPC
- Fixed bug: Twilify silently fails when texted during network stack deletion - switched to serverless instead of VPC
- Twilify ignores existing Spotify playlists with same name upon app setup, will create new playlist instead of choosing existing - use overwrite keyword to use existing
- Setup script invokes Twilio API to update phone number instead of manually copy/pasting with MFA login
- Fixed bug: Playlist doesn't have correct number of songs after songbank reset
- Completely serverless architecture
- Specify that songs are kept via Hello text - keep keyword
- Happy/sad keywords to influence playlist tracks 
- Tempo keyword to influence playlist tracks
- Instrumental keyword for playlist, if present less/minimal vocals
- Energy keyword - energy high, medium, or low
- Dance keyword - want danceable tracks
- Size keyword temporarily changes number of songs in playlist - can't use with 'keep' unless desired size is larger than current playlist size
- Seeds keyword along with track number in playlist provides which songbank songs were used to generate the playlist song - songbank keeps track of 'parents'
- Songbank contains basic song metadata instead of just spotify IDs
- Single Twilify deployment supports receiving messages from multiple users to trigger playlist generation


- [BACK-BACKLOG] Multiplayer joint playlists with song generation distributed between friends??? - OK, Spotify pretty much stole this idea ;)