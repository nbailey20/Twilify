# Twilify
Generate a Spotify playlist based on your current musical interests or mood by texting a Twilio-owned phone number which triggers a Cloud API in your personal account.
Easy AWS or GCP-based serverless deployment automated via Terraform.

## Current Version: 2.0.0 - Multi-Cloud (AWS & GCP) Support
One-script installation/deployment into AWS or GCP (why not both? ;) and automated Twilio webhook configuration for easy use. Once texted, initial playlist is created with name "Twilify" within seconds. Experiment with personalized playlist customization through text-based keywords, grant your friends permission to text the app themselves, investigate a hit new track and see how it was generated, but most importantly - quit trying to decide what music to listen to!


## Usage Instructions
- In general, texting anything will refresh the Twilify playlist
- Refreshing means - replacing all songs in the playlist with the default number of new songs, see keywords below regarding changing default behavior for a specific playlist
- Songs will be generated by randomly combining 1-3 songs in a user's Spotify current top tracks as seeds for a new song generation
- For more customizable playlist, several keywords can be included in the text body, see table below
- Case does NOT matter for your SMS messages, don't worry about auto-caps!

|           Keyword           | Sample Usage in SMS Message |                                         Description if Required                                        |
|:---------------------------:|:---------------------------:|:------------------------------------------------------------------------------------------------------:|
| Energy [high\|medium\|low]  | energy medium               |                                                                                                        |
| Happy                       | Happy yay!                  | Brighter                                                                                               |
| Sad                         | sad :(                      | Darker                                                                                                 |
| Instrumental                | instrumental                | Less vocal                                                                                             |
| Tempo [number]              | tempo 140                   |                                                                                                        |
| Dance                       | DANCE party                 | More danceable songs                                                                                   |
| Size [number]               | size 21                     | Add this many songs to the playlist for one iteration                                                  |
| Keep                        | keep                        | Does not get rid of all songs automatically,  attempts to add new songs to reach desired size          |
| Seeds [number]              | seeds 9                     | Do NOT update playlist, but return name of song(s) that  helped generate the 9th track in the playlist |
| Overwrite                   | overwrite                   | (Initial text after install only) Use if Twilify was installed previously and there is an existing playlist with correct name to overwrite instead of creating new |


## Installation Prerequisites & Instructions
1. Have access to configure an AWS account or GCP project via Terraform
2. Own a Twilio phone number that is capable of sending/receiving SMS
3. To start install, change directory to either the aws or gcp folder
4. Provide various account information needed in terraform.tfvars file (see variables.tf file for reference) - account/project ID, Spotify account, Twilio number, etc
5. Make sure terraform is installed and that it has access with necessary permission to create resources in your chosen Cloud provider
6. Run setup.sh script to build and deploy app, as well as update Twilio phone number webhook URL, no manual configuration required
7. Text your Twilify number to say hi, and enjoy :)


## Uninstall Instructions
1. Execute "terraform destroy" to get rid of everything in AWS or GCP, delete the playlist in Spotify, and don't forget to release the Twilio number. Poof, it's all gone.


## Known Bugs / Issues / Needs
- [BACKLOG] Use S3 bucket keys for KMS encryption to reduce cost 
- [BACKLOG] Need ability to accidentally delete spotify playlist and resume without having to recreate songbank, migrate keyword
- [BACKLOG] alert all registered numbers when fresh music is ready (can opt out via text?)
- [BACKLOG] "classic" song ratio keyword, want to mostly enjoy new stuff or plan to get drunk and sing to what you already love? - long term favs
- [BACKLOG] Want endless keyword so playlist keeps refreshing with new tracks as I listen without needing to text every so often, until I stop the endlessness via text
- [BACKLOG] Add S3 bucket versioning to be able to lookup previous songbanks if desired, lifecycle policy to avoid buildup


- [RESOLVED] Add support for deploying into Google Cloud, not just AWS
- [RESOLVED] Eliminate network resources / CFT and don't put Twilify in a VPC! - Decreased cost and drastically improved speed with default Lambda Internet connectivity
- [RESOLVED] Spotify refresh token should be saved in SSM Parameter Store as encrypted string, not in S3 with songbank
- [RESOLVED] Network connectivity sometimes not working when app is invoked due to CloudFormation stack finishing NATGW->IGW resource and route creation immediately beforehand - added network connectivity test to check and wait a few seconds before trying again - VPCless architecture
- [RESOLVED] Twilify doesn't immediately respond with warmup message - Hypothesis: API resource creation in TF is sometimes out of order enough to block Lambda response to text, APIGW returns 500 - updated to use trigger for APIGW TF instead of depends per AWS docs - haven't encountered error in 50+ deployments
- [RESOLVED] Songbank keeps track of / increments play count for songs even when removed from playlist
- [RESOLVED] Twilify can fail when writing new songbank back to S3, put object call is timing out - network connectivity check at start and max retries/timeouts added for boto3, verified retries via CloudWatch logs
- [RESOLVED] Spotify calls can also timeout refreshing token - shorter timeout added, VPCless architecture
- [RESOLVED] Twilify silently fails when texted during network stack deletion - no issue if warmup message works, no warmup message error in 50+ deployments
- [RESOLVED] Twilify ignores existing Spotify playlists with same name upon app setup, will create new playlist instead of choosing existing (should be variable option to overwrite)
- [RESOLVED] Update setup script to invoke Twilio API to update phone number instead of manually copy/pasting with MFA login
- [RESOLVED] Playlist doesn't have correct number of songs after songbank reset
- [RESOLVED] Need ability to temporarily remove cost-saving mode for faster responses for a user-texted amount of time - VPC-less architecture
- [RESOLVED] Need ability to specify that all songs are replaced via Hello text - reset keyword - changed to 'keep' as reset is default starting in v1.1
- [RESOLVED] Happy/sad keywords to influence playlist tracks 
- [RESOLVED] Tempo keyword to influence playlist tracks
- [RESOLVED] Instrumental keyword for playlist, if present no vocals
- [RESOLVED] Energy keyword - energy high, medium, or low
- [TESTING] Dance keyword - want danceable tracks, needs tuning
- [RESOLVED] Size keyword to temporarily change number of songs in playlist - smaller size no longer issue as all songs reset by default, can't use with 'keep' unless desired size is larger than current playlist size
- [RESOLVED] Seeds keyword along with track number in playlist to learn which songbank songs were used to generate the playlist song - need to keep track of 'parents' in songbank
- [RESOLVED] Overall make songbank more readable with words instead of just spotify IDs?
- [RESOLVED] want single Twilify deployment to work with multiple user phone numbers 


- [BACK-BACKLOG] Multiplayer joint playlists with song generation combined between friends??? - entirely new authentication setup required